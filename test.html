<!DOCTYPE html>
<html>
<head>
    <title>GPS Tracker Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin-bottom: 20px; padding: 20px; border: 1px solid #ccc; }
        .log { background-color: #f5f5f5; padding: 10px; height: 200px; overflow-y: auto; }
        button { padding: 10px; margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>GPS Tracker Test</h1>
        
        <div class="section">
            <h2>WebSocket Connection</h2>
            <button onclick="connectWebSocket()">Connect WebSocket</button>
            <button onclick="sendTestData()">Send Test Data</button>
            <button onclick="disconnectWebSocket()">Disconnect</button>
            <div id="wsLog" class="log"></div>
        </div>

        <div class="section">
            <h2>REST API Test</h2>
            <button onclick="testExport()">Test Export API</button>
            <div id="apiLog" class="log"></div>
        </div>
    </div>

    <script>
        let ws;
        const deviceId = 'test-device-001';

        function log(area, message) {
            const logArea = document.getElementById(area);
            logArea.innerHTML += message + '<br>';
            logArea.scrollTop = logArea.scrollHeight;
        }

        function connectWebSocket() {
            ws = new WebSocket(`ws://localhost:8080/gps?deviceId=${deviceId}`);
            
            ws.onopen = () => {
                log('wsLog', 'Connected to WebSocket');
            };

            ws.onmessage = (event) => {
                log('wsLog', 'Received: ' + event.data);
            };

            ws.onerror = (error) => {
                log('wsLog', 'Error: ' + error);
            };

            ws.onclose = () => {
                log('wsLog', 'Disconnected from WebSocket');
            };
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
            }
        }

        function sendTestData() {
            if (!ws) {
                log('wsLog', 'Please connect first');
                return;
            }

            const testData = {
                deviceId: deviceId,
                latitude: 37.7749,
                longitude: -122.4194,
                speed: 30.5,
                heading: 180.0,
                timestamp: new Date().toISOString(),
                additionalInfo: "Test data"
            };

            ws.send(JSON.stringify(testData));
            log('wsLog', 'Sent: ' + JSON.stringify(testData));
        }

        function testExport() {
            const now = new Date();
            const startTime = new Date(now.getTime() - (24 * 60 * 60 * 1000)).toISOString(); // 24 hours ago
            const endTime = now.toISOString();
            
            const url = `http://localhost:8080/api/gps/export?deviceId=${deviceId}&startTime=${startTime}&endTime=${endTime}`;
            
            log('apiLog', 'Testing export API...');
            
            fetch(url, {
                headers: {
                    'Authorization': 'Basic ' + btoa('admin:admin')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `gps_data_${deviceId}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                log('apiLog', 'Export successful! File downloaded.');
            })
            .catch(error => {
                log('apiLog', 'Error: ' + error);
            });
        }
    </script>
</body>
</html>
